name: Tailor Resume

on:
  workflow_dispatch:
    inputs:
      job_description:
        description: 'Job description text or link'
        required: true
        type: string

permissions:
  contents: write

jobs:
  tailor:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/xu-cheng/texlive-full:latest

    env:
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      MODEL: "gemini-2.0-flash"

    steps:

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Load master prompt
        run: |
          PROMPT=$(sed 's/"/\\"/g' prompt/master_prompt.txt)
          echo "PROMPT<<EOF" >> $GITHUB_ENV
          echo "$PROMPT" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Prepare Gemini payload
        run: |
          mkdir -p resumes
          BASE=$(sed 's/"/\\"/g' resume/base_resume.tex)
          JOB="${{ github.event.inputs.job_description }}"

          cat > payload.json <<EOF
          {
            "contents": [{
              "parts": [{
                "text": "base_resume:\n$BASE\n\njob_description:\n$JOB\n\n${PROMPT}"
              }]
            }]
          }
          EOF

      - name: Call Gemini API
        run: |
          curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "x-goog-api-key: $GEMINI_API_KEY" \
            -d @payload.json \
            "https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent" \
            -o response.json

      - name: Extract company name and LaTeX safely
        run: |
          mkdir -p resumes
          RAW=$(jq -r '.candidates[0].content.parts[0].text' response.json)

          # Try parsing JSON output
          COMPANY=$(echo "$RAW" | jq -r '.company_name // empty' 2>/dev/null)
          LATEX=$(echo "$RAW" | jq -r '.latex_resume // empty' 2>/dev/null)

          # Fallback if Gemini returned raw LaTeX text
          if [ -z "$LATEX" ]; then
            LATEX="$RAW"
          fi

          # Fallback company name
          if [ -z "$COMPANY" ] || [ "$COMPANY" = "null" ]; then
            COMPANY="Unknown"
          fi

          # Sanitize company name for filenames
          SAFE_COMPANY=$(echo "$COMPANY" | tr -cd '[:alnum:]_-')
          DATE=$(date +'%Y-%m-%d')
          OUTFILE="resumes/Ashwin_Joshi_Resume_${SAFE_COMPANY}_${DATE}.tex"

          # Write LaTeX to file
          echo "$LATEX" > "$OUTFILE"

          # Pre-check LaTeX
          if ! grep -q "\\begin{document}" "$OUTFILE"; then
            echo "Error: Gemini did not return a valid LaTeX document."
            cat "$OUTFILE"
            exit 1
          fi

          echo "COMPANY=$COMPANY" >> $GITHUB_ENV
          echo "OUTFILE=$OUTFILE" >> $GITHUB_ENV

      - name: Compile PDF
        run: |
          pdflatex -output-directory=resumes "$OUTFILE"

      - name: Commit tailored resume
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add resumes/
          git commit -m "Add tailored resume for $COMPANY ($DATE)" || echo "No changes to commit"
          git push

name: Tailor Resume

on:
  workflow_dispatch:
    inputs:
      job_description:
        description: "Job description text or link"
        required: true
        type: string

permissions:
  contents: write

jobs:
  tailor:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/xu-cheng/texlive-full:latest

    env:
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      MODEL: "gemini-2.0-flash"

    steps:

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq
        run: |
          apk update || true
          apk add jq || true

      - name: Load master prompt
        run: |
          PROMPT=$(sed 's/"/\\"/g' prompt/master_prompt.txt)
          {
            echo "PROMPT<<EOF"
            echo "$PROMPT"
            echo "EOF"
          } >> "$GITHUB_ENV"

      - name: Prepare payload
        run: |
          BASE=$(sed 's/"/\\"/g' resume/base_resume.tex)
          JOB="${{ github.event.inputs.job_description }}"

          cat > payload.json <<EOF
          {
            "contents": [{
              "parts": [{
                "text": "base_resume:\n$BASE\n\njob_description:\n$JOB\n\n${PROMPT}"
              }]
            }]
          }
          EOF

      - name: Call Gemini API
        run: |
          curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "x-goog-api-key: $GEMINI_API_KEY" \
            -d @payload.json \
            "https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent" \
            -o response.json

      - name: Extract company name and LaTeX from JSON
        run: |
          # Extract raw model output
          RAW=$(jq -r '.candidates[0].content.parts[0].text' response.json)
          echo "$RAW" > raw_output.json

          # Parse fields
          COMPANY=$(jq -r '.company_name' raw_output.json)
          LATEX=$(jq -r '.latex_resume' raw_output.json)

          # Ensure company name exists
          if [ "$COMPANY" = "null" ] || [ -z "$COMPANY" ]; then
            COMPANY="Unknown"
          fi

          # Sanitize company name for filenames
          SAFE_COMPANY=$(echo "$COMPANY" | tr -cd '[:alnum:]_-')

          DATE=$(date +'%Y-%m-%d')
          OUTFILE="resumes/Ashwin_Joshi_Resume_${SAFE_COMPANY}_${DATE}.tex"

          echo "$LATEX" > "$OUTFILE"

          echo "COMPANY=$COMPANY" >> $GITHUB_ENV
          echo "OUTFILE=$OUTFILE" >> $GITHUB_ENV

      - name: Compile PDF
        run: |
          pdflatex -output-directory=resumes "$OUTFILE"

      - name: Commit tailored resume
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add resumes/
          git commit -m "Add tailored resume for $COMPANY ($DATE)" || echo "No changes to commit"
          git push
